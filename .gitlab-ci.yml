image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest

stages:
  - deploy
  - release

release:
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  stage: release
  before_script:
    - apk add zip curl
  script:
    - cd modules
    - mkdir temp
    - mkdir temp/config
    - cp -r base/default/* temp/config
    - cp -r network/hub-and-spoke/* temp/config
    - mkdir temp/docs
    - cp -r ../docs/* temp/docs
    - cd temp
    - zip -r ../../lza-universal-config-hub-and-spoke-$CI_COMMIT_TAG.zip .
    - ls -al $CI_PROJECT_DIR/lza-universal-config-hub-and-spoke-$CI_COMMIT_TAG.zip
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file $CI_PROJECT_DIR/lza-universal-config-hub-and-spoke-$CI_COMMIT_TAG.zip "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/lza-universal-config/${CI_COMMIT_TAG}/lza-universal-config-hub-and-spoke-$CI_COMMIT_TAG.zip"
    - cd ..
    - rm -rf temp
    - mkdir temp
    - mkdir temp/config
    - cp -r base/default/* temp/config
    - cp -r network/shared-vpc/* temp/config
    - mkdir temp/docs
    - cp -r ../docs/* temp/docs
    - cd temp
    - zip -r ../../lza-universal-config-shared-vpc-$CI_COMMIT_TAG.zip .
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file $CI_PROJECT_DIR/lza-universal-config-shared-vpc-$CI_COMMIT_TAG.zip "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/lza-universal-config/${CI_COMMIT_TAG}/lza-universal-config-shared-vpc-$CI_COMMIT_TAG.zip"
  artifacts:
    paths:
      - lza-universal-config-hub-and-spoke-$CI_COMMIT_TAG.zip
      - lza-universal-config-shared-vpc-$CI_COMMIT_TAG.zip
  rules:
    - if: $CI_PROJECT_ID == "115191" && $CI_COMMIT_TAG =~ /v(\d.+){2}\d/
      when: always
    - when: never
  release:
    tag_name: "$CI_COMMIT_TAG"
    description: "$CI_COMMIT_TAG"
    ref: "$CI_COMMIT_SHA"
    assets:
      links:
        - name: lza-universal-config-hub-and-spoke-$CI_COMMIT_TAG.zip
          url: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/lza-universal-config/${CI_COMMIT_TAG}/lza-universal-config-hub-and-spoke-$CI_COMMIT_TAG.zip
        - name: lza-universal-config-shared-vpc-$CI_COMMIT_TAG.zip
          url: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/lza-universal-config/${CI_COMMIT_TAG}/lza-universal-config-shared-vpc-$CI_COMMIT_TAG.zip

.base_with_hub_and_spoke:
  before_script:
    - apt-get update -yq
  script:
    - apt-get install nodejs npm -yq
    - cd modules
    - mkdir temp
    - cp -r base/default/* temp/
    - cp -r network/hub-and-spoke/* temp/
    - cd ../scripts
    - npm install
    - node index.js ../modules/temp/
    - cd ../modules/temp
    - zip -r ../../aws-accelerator-config.zip . &>/dev/null
    - cd ../..
    # Get local file size
    - LOCAL_SIZE=$(stat -c%s aws-accelerator-config.zip)
    - echo "Uploading ${LOCAL_SIZE} bytes to ${CONFIG_BUCKET_NAME}"
    # Upload file
    - aws s3 cp aws-accelerator-config.zip s3://${CONFIG_BUCKET_NAME}/zipped/aws-accelerator-config.zip
    # Verify upload
    - |
      echo "Verifying upload..."
      S3_SIZE=$(aws s3api head-object --bucket ${CONFIG_BUCKET_NAME} --key zipped/aws-accelerator-config.zip --query 'ContentLength' --output text)
      echo "Local: ${LOCAL_SIZE} bytes, S3: ${S3_SIZE} bytes"
      if [ "$LOCAL_SIZE" != "$S3_SIZE" ]; then echo "Upload failed - size mismatch" && exit 1; fi
      echo "Upload verified successfully"
    # Start CodePipeline
    - |
      if [ "$AWS_DEFAULT_REGION" = "$HOME_REGION" ]; then
        PIPELINE_NAME="AWSAccelerator-Pipeline"
        echo "Starting pipeline: ${PIPELINE_NAME} in home region: $HOME_REGION"
        if EXECUTION_ID=$(aws codepipeline start-pipeline-execution --name ${PIPELINE_NAME} --query 'pipelineExecutionId' --output text 2>/dev/null); then
          echo "Pipeline execution started: $EXECUTION_ID"
          while true; do
            if STATUS=$(aws codepipeline get-pipeline-execution --pipeline-name ${PIPELINE_NAME} --pipeline-execution-id $EXECUTION_ID --query 'pipelineExecution.status' --output text 2>/dev/null); then
              echo "Pipeline status: $STATUS"
              case $STATUS in
                "Succeeded") echo "Pipeline completed successfully" && break ;;
                "Failed"|"Cancelled"|"Stopped") echo "Pipeline failed: $STATUS" && exit 1 ;;
                "InProgress") sleep 60 ;;
                *) echo "Unknown status: $STATUS" && exit 1 ;;
              esac
            else
              STATUS=$(aws codepipeline list-pipeline-executions --pipeline-name ${PIPELINE_NAME} --max-items 1 --query 'pipelineExecutionSummaries[0].status' --output text 2>/dev/null)
              echo "Recent status: $STATUS"
              case $STATUS in
                "Succeeded") echo "Pipeline completed successfully" && break ;;
                "Failed"|"Cancelled"|"Stopped") echo "Pipeline failed: $STATUS" && exit 1 ;;
                *) sleep 60 ;;
              esac
            fi
          done
        else
          echo "Failed to start pipeline in home region" && exit 1
        fi
      else
        echo "Skipping pipeline - not home region (current: $AWS_DEFAULT_REGION, home: $HOME_REGION)"
      fi
  artifacts:
    paths:
      - aws-accelerator-config.zip
    expire_in: 1 week

.base_with_shared_vpc:
  before_script:
    - apt-get update -yq
  script:
    - apt-get install nodejs npm -yq
    - cd modules
    - mkdir temp
    - cp -r base/default/* temp/
    - cp -r network/shared-vpc/* temp/
    - cd ../scripts
    - npm install
    - node index.js ../modules/temp/
    - cd ../modules/temp
    - zip -r ../../aws-accelerator-config.zip . &>/dev/null
    - cd ../..
    # Get local file size
    - LOCAL_SIZE=$(stat -c%s aws-accelerator-config.zip)
    - echo "Uploading ${LOCAL_SIZE} bytes to ${CONFIG_BUCKET_NAME}"
    # Upload file
    - aws s3 cp aws-accelerator-config.zip s3://${CONFIG_BUCKET_NAME}/zipped/aws-accelerator-config.zip
    # Verify upload
    - |
      echo "Verifying upload..."
      S3_SIZE=$(aws s3api head-object --bucket ${CONFIG_BUCKET_NAME} --key zipped/aws-accelerator-config.zip --query 'ContentLength' --output text)
      echo "Local: ${LOCAL_SIZE} bytes, S3: ${S3_SIZE} bytes"
      if [ "$LOCAL_SIZE" != "$S3_SIZE" ]; then echo "Upload failed - size mismatch" && exit 1; fi
      echo "Upload verified successfully"
    # Start CodePipeline
    - |
      if [ "$AWS_DEFAULT_REGION" = "$HOME_REGION" ]; then
        PIPELINE_NAME="AWSAccelerator-Pipeline"
        echo "Starting pipeline: ${PIPELINE_NAME} in home region: $HOME_REGION"
        if EXECUTION_ID=$(aws codepipeline start-pipeline-execution --name ${PIPELINE_NAME} --query 'pipelineExecutionId' --output text 2>/dev/null); then
          echo "Pipeline execution started: $EXECUTION_ID"
          while true; do
            if STATUS=$(aws codepipeline get-pipeline-execution --pipeline-name ${PIPELINE_NAME} --pipeline-execution-id $EXECUTION_ID --query 'pipelineExecution.status' --output text 2>/dev/null); then
              echo "Pipeline status: $STATUS"
              case $STATUS in
                "Succeeded") echo "Pipeline completed successfully" && break ;;
                "Failed"|"Cancelled"|"Stopped") echo "Pipeline failed: $STATUS" && exit 1 ;;
                "InProgress") sleep 60 ;;
                *) echo "Unknown status: $STATUS" && exit 1 ;;
              esac
            else
              STATUS=$(aws codepipeline list-pipeline-executions --pipeline-name ${PIPELINE_NAME} --max-items 1 --query 'pipelineExecutionSummaries[0].status' --output text 2>/dev/null)
              echo "Recent status: $STATUS"
              case $STATUS in
                "Succeeded") echo "Pipeline completed successfully" && break ;;
                "Failed"|"Cancelled"|"Stopped") echo "Pipeline failed: $STATUS" && exit 1 ;;
                *) sleep 60 ;;
              esac
            fi
          done
        else
          echo "Failed to start pipeline in home region" && exit 1
        fi
      else
        echo "Skipping pipeline - not home region (current: $AWS_DEFAULT_REGION, home: $HOME_REGION)"
      fi
  artifacts:
    paths:
      - aws-accelerator-config.zip
    expire_in: 1 week

# DEV

dev001-us-east-1-default_base_with_hub_and_spoke_network:
  extends: .base_with_hub_and_spoke
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"
  variables:
    AWS_DEFAULT_REGION: "us-east-1"
    AWS_CREDS_TARGET_ROLE: "${DEV001_US_EAST_1_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${DEV001_US_EAST_1_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-dev001"
    HOME_REGION: "us-east-1"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

dev001-us-west-2-default_base_with_hub_and_spoke_network:
  extends: .base_with_hub_and_spoke
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"
  variables:
    AWS_DEFAULT_REGION: "us-west-2"
    AWS_CREDS_TARGET_ROLE: "${DEV001_US_WEST_2_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${DEV001_US_WEST_2_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-dev001"
    HOME_REGION: "us-west-2"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

dev001-ca-central-1-default_base_with_hub_and_spoke_network:
  extends: .base_with_hub_and_spoke
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"
  variables:
    AWS_DEFAULT_REGION: "ca-central-1"
    AWS_CREDS_TARGET_ROLE: "${DEV001_CA_CENTRAL_1_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${DEV001_CA_CENTRAL_1_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-dev001"
    HOME_REGION: "ca-central-1"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

dev001-ap-southeast-2-default_base_with_hub_and_spoke_network:
  extends: .base_with_hub_and_spoke
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"
  variables:
    AWS_DEFAULT_REGION: "ap-southeast-2"
    AWS_CREDS_TARGET_ROLE: "${DEV001_AP_SOUTHEAST_2_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${DEV001_AP_SOUTHEAST_2_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-dev001"
    HOME_REGION: "ap-southeast-2"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

dev001-eu-west-2-default_base_with_hub_and_spoke_network:
  extends: .base_with_hub_and_spoke
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"
  variables:
    AWS_DEFAULT_REGION: "eu-west-2"
    AWS_CREDS_TARGET_ROLE: "${DEV001_EU_WEST_2_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${DEV001_EU_WEST_2_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-dev001"
    HOME_REGION: "eu-west-2"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

dev002-us-east-1-default_base_with_shared_vpc_network:
  extends: .base_with_shared_vpc
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"
  variables:
    AWS_DEFAULT_REGION: "us-east-1"
    AWS_CREDS_TARGET_ROLE: "${DEV002_US_EAST_1_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${DEV002_US_EAST_1_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-dev002"
    HOME_REGION: "us-east-1"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

dev002-us-west-2-default_base_with_shared_vpc_network:
  extends: .base_with_shared_vpc
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"
  variables:
    AWS_DEFAULT_REGION: "us-west-2"
    AWS_CREDS_TARGET_ROLE: "${DEV002_US_WEST_2_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${DEV002_US_WEST_2_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-dev002"
    HOME_REGION: "us-west-2"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

dev002-ca-central-1-default_base_with_shared_vpc_network:
  extends: .base_with_shared_vpc
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"
  variables:
    AWS_DEFAULT_REGION: "ca-central-1"
    AWS_CREDS_TARGET_ROLE: "${DEV002_CA_CENTRAL_1_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${DEV002_CA_CENTRAL_1_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-dev002"
    HOME_REGION: "ca-central-1"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

dev002-ap-southeast-2-default_base_with_shared_vpc_network:
  extends: .base_with_shared_vpc
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"
  variables:
    AWS_DEFAULT_REGION: "ap-southeast-2"
    AWS_CREDS_TARGET_ROLE: "${DEV002_AP_SOUTHEAST_2_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${DEV002_AP_SOUTHEAST_2_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-dev002"
    HOME_REGION: "ap-southeast-2"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

dev002-eu-west-2-default_base_with_shared_vpc_network:
  extends: .base_with_shared_vpc
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"
  variables:
    AWS_DEFAULT_REGION: "eu-west-2"
    AWS_CREDS_TARGET_ROLE: "${DEV002_EU_WEST_2_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${DEV002_EU_WEST_2_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-dev002"
    HOME_REGION: "eu-west-2"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

# TEST

test001-us-east-1-default_base_with_hub_and_spoke_network:
  extends: .base_with_hub_and_spoke
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "test"
  variables:
    AWS_DEFAULT_REGION: "us-east-1"
    AWS_CREDS_TARGET_ROLE: "${TEST001_US_EAST_1_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${TEST001_US_EAST_1_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-test001"
    HOME_REGION: "us-east-1"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

test001-us-west-2-default_base_with_hub_and_spoke_network:
  extends: .base_with_hub_and_spoke
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "test"
  variables:
    AWS_DEFAULT_REGION: "us-west-2"
    AWS_CREDS_TARGET_ROLE: "${TEST001_US_WEST_2_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${TEST001_US_WEST_2_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-test001"
    HOME_REGION: "us-west-2"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

test001-ca-central-1-default_base_with_hub_and_spoke_network:
  extends: .base_with_hub_and_spoke
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "test"
  variables:
    AWS_DEFAULT_REGION: "ca-central-1"
    AWS_CREDS_TARGET_ROLE: "${TEST001_CA_CENTRAL_1_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${TEST001_CA_CENTRAL_1_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-test001"
    HOME_REGION: "ca-central-1"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

test001-ap-southeast-2-default_base_with_hub_and_spoke_network:
  extends: .base_with_hub_and_spoke
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "test"
  variables:
    AWS_DEFAULT_REGION: "ap-southeast-2"
    AWS_CREDS_TARGET_ROLE: "${TEST001_AP_SOUTHEAST_2_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${TEST001_AP_SOUTHEAST_2_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-test001"
    HOME_REGION: "ap-southeast-2"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

test001-eu-west-2-default_base_with_hub_and_spoke_network:
  extends: .base_with_hub_and_spoke
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "test"
  variables:
    AWS_DEFAULT_REGION: "eu-west-2"
    AWS_CREDS_TARGET_ROLE: "${TEST001_EU_WEST_2_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${TEST001_EU_WEST_2_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-test001"
    HOME_REGION: "eu-west-2"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

test002-us-east-1-default_base_with_shared_vpc_network:
  extends: .base_with_shared_vpc
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "test"
  variables:
    AWS_DEFAULT_REGION: "us-east-1"
    AWS_CREDS_TARGET_ROLE: "${TEST002_US_EAST_1_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${TEST002_US_EAST_1_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-test002"
    HOME_REGION: "us-east-1"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

test002-us-west-2-default_base_with_shared_vpc_network:
  extends: .base_with_shared_vpc
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "test"
  variables:
    AWS_DEFAULT_REGION: "us-west-2"
    AWS_CREDS_TARGET_ROLE: "${TEST002_US_WEST_2_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${TEST002_US_WEST_2_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-test002"
    HOME_REGION: "us-west-2"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

test002-ca-central-1-default_base_with_shared_vpc_network:
  extends: .base_with_shared_vpc
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "test"
  variables:
    AWS_DEFAULT_REGION: "ca-central-1"
    AWS_CREDS_TARGET_ROLE: "${TEST002_CA_CENTRAL_1_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${TEST002_CA_CENTRAL_1_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-test002"
    HOME_REGION: "ca-central-1"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

test002-ap-southeast-2-default_base_with_shared_vpc_network:
  extends: .base_with_shared_vpc
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "test"
  variables:
    AWS_DEFAULT_REGION: "ap-southeast-2"
    AWS_CREDS_TARGET_ROLE: "${TEST002_AP_SOUTHEAST_2_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${TEST002_AP_SOUTHEAST_2_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-test002"
    HOME_REGION: "ap-southeast-2"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

test002-eu-west-2-default_base_with_shared_vpc_network:
  extends: .base_with_shared_vpc
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "test"
  variables:
    AWS_DEFAULT_REGION: "eu-west-2"
    AWS_CREDS_TARGET_ROLE: "${TEST002_EU_WEST_2_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${TEST002_EU_WEST_2_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-test002"
    HOME_REGION: "eu-west-2"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

# PROD

prod001-us-east-1-default_base_with_hub_and_spoke_network:
  extends: .base_with_hub_and_spoke
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "prod"
  variables:
    AWS_DEFAULT_REGION: "us-east-1"
    AWS_CREDS_TARGET_ROLE: "${PROD001_US_EAST_1_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${PROD001_US_EAST_1_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-prod001"
    HOME_REGION: "us-east-1"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

prod001-us-west-2-default_base_with_hub_and_spoke_network:
  extends: .base_with_hub_and_spoke
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "prod"
  variables:
    AWS_DEFAULT_REGION: "us-west-2"
    AWS_CREDS_TARGET_ROLE: "${PROD001_US_WEST_2_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${PROD001_US_WEST_2_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-prod001"
    HOME_REGION: "us-west-2"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

prod001-ca-central-1-default_base_with_hub_and_spoke_network:
  extends: .base_with_hub_and_spoke
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "prod"
  variables:
    AWS_DEFAULT_REGION: "ca-central-1"
    AWS_CREDS_TARGET_ROLE: "${PROD001_CA_CENTRAL_1_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${PROD001_CA_CENTRAL_1_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-prod001"
    HOME_REGION: "ca-central-1"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

prod001-ap-southeast-2-default_base_with_hub_and_spoke_network:
  extends: .base_with_hub_and_spoke
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "prod"
  variables:
    AWS_DEFAULT_REGION: "ap-southeast-2"
    AWS_CREDS_TARGET_ROLE: "${PROD001_AP_SOUTHEAST_2_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${PROD001_AP_SOUTHEAST_2_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-prod001"
    HOME_REGION: "ap-southeast-2"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

prod001-eu-west-2-default_base_with_hub_and_spoke_network:
  extends: .base_with_hub_and_spoke
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "prod"
  variables:
    AWS_DEFAULT_REGION: "eu-west-2"
    AWS_CREDS_TARGET_ROLE: "${PROD001_EU_WEST_2_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${PROD001_EU_WEST_2_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-prod001"
    HOME_REGION: "eu-west-2"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

prod002-us-east-1-default_base_with_shared_vpc_network:
  extends: .base_with_shared_vpc
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "prod"
  variables:
    AWS_DEFAULT_REGION: "us-east-1"
    AWS_CREDS_TARGET_ROLE: "${PROD002_US_EAST_1_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${PROD002_US_EAST_1_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-prod002"
    HOME_REGION: "us-east-1"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

prod002-us-west-2-default_base_with_shared_vpc_network:
  extends: .base_with_shared_vpc
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "prod"
  variables:
    AWS_DEFAULT_REGION: "us-west-2"
    AWS_CREDS_TARGET_ROLE: "${PROD002_US_WEST_2_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${PROD002_US_WEST_2_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-prod002"
    HOME_REGION: "us-west-2"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

prod002-ca-central-1-default_base_with_shared_vpc_network:
  extends: .base_with_shared_vpc
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "prod"
  variables:
    AWS_DEFAULT_REGION: "ca-central-1"
    AWS_CREDS_TARGET_ROLE: "${PROD002_CA_CENTRAL_1_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${PROD002_CA_CENTRAL_1_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-prod002"
    HOME_REGION: "ca-central-1"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

prod002-ap-southeast-2-default_base_with_shared_vpc_network:
  extends: .base_with_shared_vpc
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "prod"
  variables:
    AWS_DEFAULT_REGION: "ap-southeast-2"
    AWS_CREDS_TARGET_ROLE: "${PROD002_AP_SOUTHEAST_2_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${PROD002_AP_SOUTHEAST_2_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-prod002"
    HOME_REGION: "ap-southeast-2"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1

prod002-eu-west-2-default_base_with_shared_vpc_network:
  extends: .base_with_shared_vpc
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "prod"
  variables:
    AWS_DEFAULT_REGION: "eu-west-2"
    AWS_CREDS_TARGET_ROLE: "${PROD002_EU_WEST_2_GITLAB_S3_ROLE}"
    CONFIG_BUCKET_NAME: "${PROD002_EU_WEST_2_CONFIG_BUCKET_NAME}"
    ENVIRONMENT_NAME: "uc-prod002"
    HOME_REGION: "eu-west-2"
    ENABLED_REGIONS: "us-east-1,us-west-2,ca-central-1,eu-west-2,ap-southeast-2"
    WORKLOAD_DEV_ACCOUNTS: 1
    WORKLOAD_TEST_ACCOUNTS: 1
    WORKLOAD_PROD_ACCOUNTS: 1
    WORKLOAD_SANDBOX_ACCOUNTS: 1
